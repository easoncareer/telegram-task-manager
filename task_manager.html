<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Telegram Mini App Prototype</title>
<style>
body { font-family: sans-serif; margin: 0; padding: 1rem; background: #f0f0f0; }
header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
button { padding: 0.5rem 1rem; margin: 0.25rem; }
.card { background: #fff; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 0.5rem; }
img, video { max-width: 100%; border-radius: 0.25rem; }
input[type="file"] { margin-top: 0.5rem; }
select, input { padding: 0.25rem; margin: 0.25rem 0; }
.status-badge { font-size: 0.8rem; background: #ddd; padding: 0.2rem 0.4rem; border-radius: 0.25rem; margin-left: 0.25rem; }
</style>
</head>
<body>

<header>
  <div>
    <label>Role: 
      <select id="roleSelect">
        <option>Admin</option>
        <option>Lead</option>
        <option>Member</option>
        <option>Viewer</option>
      </select>
    </label>
  </div>
  <div>Telegram Mini App Prototype</div>
</header>

<section>
  <h2>Create Task</h2>
  <input type="text" id="taskTitle" placeholder="Title (optional)"><br>
  <input type="date" id="taskDate"><br>
  <input type="number" id="taskSets" value="1" min="1" placeholder="Sets"><br>
  <label><input type="checkbox" id="taskVideo"> Label: Video (requires ≥1 video)</label><br>
  <label>Photo (required): <input type="file" id="taskPhoto" accept="image/*"></label><br>
  <button id="createTaskBtn">Create Task</button>
</section>

<section>
  <h2>Task List</h2>
  <div id="taskList"></div>
</section>

<section>
  <h2>Task Detail</h2>
  <div id="taskDetail"></div>
</section>

<script>
// --- LocalStorage mock backend ---
let tasks = JSON.parse(localStorage.getItem('tm_tasks')||'[]');
let currentRole = document.getElementById('roleSelect').value;

document.getElementById('roleSelect').addEventListener('change', (e)=>{
  currentRole = e.target.value;
  renderTaskList();
});

// --- Utility ---
function uid(prefix='id'){ return prefix+'_'+Math.random().toString(36).slice(2,9); }
function nowISO(){ return new Date().toISOString(); }
function saveTasks(){ localStorage.setItem('tm_tasks', JSON.stringify(tasks)); }

// --- Task creation ---
document.getElementById('createTaskBtn').addEventListener('click', ()=>{
  const title = document.getElementById('taskTitle').value;
  const willReceiveOn = document.getElementById('taskDate').value || null;
  const requireSets = Number(document.getElementById('taskSets').value)||1;
  const labels = { video: document.getElementById('taskVideo').checked };
  const photoInput = document.getElementById('taskPhoto');
  if(!photoInput.files[0]) return alert('Photo required');
  const reader = new FileReader();
  reader.onload = (e)=>{
    const createdPhoto = { id: uid('cp'), url:e.target.result, locked:true, by:currentRole };
    const task = {
      id: uid('task'),
      title, status:'New', labels, requireSets, willReceiveOn,
      createdPhoto, uploads:[createdPhoto],
      createdBy:currentRole, doneBy:null,
      createdAt: nowISO(),
      history:[{at:nowISO(),by:currentRole,action:'Created'}]
    };
    tasks.unshift(task);
    saveTasks();
    renderTaskList();
  };
  reader.readAsDataURL(photoInput.files[0]);
});

// --- Render Task List ---
function renderTaskList(){
  const container = document.getElementById('taskList');
  container.innerHTML='';
  tasks.forEach(task=>{
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <strong>${task.title||'(no title)'}</strong>
      <span class="status-badge">${task.status}</span><br>
      By ${task.createdBy} • ${new Date(task.createdAt).toLocaleString()}<br>
      <button onclick="showDetail('${task.id}')">Open</button>
    `;
    container.appendChild(card);
  });
}
renderTaskList();

// --- Show Task Detail ---
function showDetail(id){
  const task = tasks.find(t=>t.id===id);
  const container = document.getElementById('taskDetail');
  container.innerHTML='';
  if(!task) return container.innerHTML='Task not found';
  const div = document.createElement('div');
  div.className='card';
  div.innerHTML=`
    <strong>${task.title||'(no title)'}</strong>
    <br>Status: ${task.status}
    <br>Created by: ${task.createdBy}
    <br>Done By: ${task.doneBy||'-'}
    <br><img src="${task.createdPhoto.url}" style="width:100%;height:auto;">
    <div id="uploads"></div>
    <input type="file" id="addUpload" accept="image/*,video/*"><br>
  `;
  container.appendChild(div);

  const uploadsDiv = div.querySelector('#uploads');
  function renderUploads(){
    uploadsDiv.innerHTML='';
    task.uploads.forEach(u=>{
      const el = document.createElement('div');
      el.innerHTML= u.kind==='image' ? `<img src="${u.url}" style="width:80px;">` : `<video src="${u.url}" style="width:120px;" controls></video>`;
      el.innerHTML+=` by ${u.by}`;
      uploadsDiv.appendChild(el);
    });
  }
  renderUploads();

  div.querySelector('#addUpload').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload=(ev)=>{
      const kind = f.type.startsWith('video/')?'video':'image';
      task.uploads.push({id:uid('up'),url:ev.target.result,kind,by:currentRole});
      task.history.unshift({at:nowISO(),by:currentRole,action:'Uploaded '+kind});
      saveTasks();
      renderUploads();
    };
    reader.readAsDataURL(f);
  });

  // --- Actions ---
  const actions = document.createElement('div');
  actions.style.marginTop='0.5rem';
  function addBtn(label,fn){ const b=document.createElement('button'); b.innerText=label; b.onclick=fn; actions.appendChild(b); }

  if(task.status==='New' && ['Admin','Lead','Member'].includes(currentRole))
    addBtn('Receive', ()=>transition(task,'Received'));
  if(task.status==='Received' && ['Admin','Lead','Member'].includes(currentRole))
    addBtn('Submit', ()=>transition(task,'Submitted'));
  if(task.status==='Submitted' && ['Admin','Lead'].includes(currentRole)){
    addBtn('Send Back (Redo)', ()=>transition(task,'Redo'));
    addBtn('Complete', ()=>transition(task,'Completed'));
  }
  if(task.status==='Redo' && ['Admin','Lead','Member'].includes(currentRole))
    addBtn('Submit', ()=>transition(task,'Submitted'));
  if(['Submitted','Completed'].includes(task.status) && ['Viewer','Lead','Admin'].includes(currentRole))
    addBtn('Archive', ()=>transition(task,'Archived'));
  container.appendChild(actions);
}

// --- Transition logic ---
function transition(task,to){
  if(to==='Submitted' && task.labels.video && !task.uploads.some(u=>u.kind==='video'))
    return alert('Video required before submission');
  if(task.status==='Received' && to==='Submitted') task.doneBy=currentRole;
  task.status=to;
  task.history.unshift({at:nowISO(),by:currentRole,action:`${task.status} → ${to}`});
  saveTasks();
  renderTaskList();
  showDetail(task.id);
}
</script>
</body>
</html>
