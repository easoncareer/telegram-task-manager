<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Telegram Task Manager Prototype</title>
<style>
  body { font-family: sans-serif; margin:0; padding:0; background:#f0f0f0;}
  .container { max-width:600px; margin:auto; padding:16px; }
  .card { background:#fff; padding:12px; margin-bottom:12px; border-radius:8px; }
  .btn { padding:6px 12px; margin:2px; border:none; border-radius:4px; cursor:pointer;}
  .btn-primary { background:#1d4ed8; color:#fff;}
  .btn-secondary { background:#e5e7eb;}
  img, video { max-width:100%; border-radius:4px; margin-top:4px;}
  select,input { padding:4px; margin:2px;}
</style>
</head>
<body>
<div class="container">
  <h2>Telegram Task Manager Prototype</h2>

  <!-- Role selector -->
  <div class="card">
    <label for="role">Select Role:</label>
    <select id="role">
      <option>Admin</option>
      <option>Lead</option>
      <option>Member</option>
      <option>Viewer</option>
    </select>
  </div>

  <!-- Task creation -->
  <div class="card" id="taskCreateCard">
    <h3>Create Task</h3>
    <input type="text" id="taskTitle" placeholder="Title (optional)"><br>
    <input type="date" id="taskDate"><br>
    <input type="number" id="taskSets" placeholder="Require Sets" value="1" min="1"><br>
    <label><input type="checkbox" id="taskVideo"> Label: Video</label><br>
    <input type="file" id="taskPhoto" accept="image/*"><br>
    <button class="btn btn-primary" onclick="createTask()">Create Task</button>
  </div>

  <!-- Task list -->
  <div id="taskList"></div>
</div>

<script>
// --- State ---
let currentRole = 'Admin';
let tasks = [];

// Role dropdown
document.getElementById('role').addEventListener('change', (e)=>{
  currentRole = e.target.value;
  console.log('Selected role:', currentRole);
  renderTasks();
});

// --- Helpers ---
function uid() { return 'id_'+Math.random().toString(36).slice(2,9); }
function canCreate() { return ['Admin','Lead','Viewer'].includes(currentRole); }
function canUpload() { return ['Admin','Lead','Member'].includes(currentRole); }
function canSubmit(task) { 
  if(task.status==='Received'||task.status==='Redo') return ['Admin','Lead','Member'].includes(currentRole); 
  return false;
}
function canReceive(task) { return task.status==='New' && ['Admin','Lead','Member'].includes(currentRole); }
function canComplete(task) { return task.status==='Submitted' && ['Admin','Lead'].includes(currentRole); }
function canRedo(task) { return task.status==='Submitted' && ['Admin','Lead'].includes(currentRole); }
function canArchive(task) { 
  if(currentRole==='Viewer') return ['Submitted','Completed'].includes(task.status);
  return ['Admin','Lead'].includes(currentRole);
}

// --- Task logic ---
function createTask(){
  if(!canCreate()){ alert('Role cannot create tasks'); return; }
  const photoInput = document.getElementById('taskPhoto');
  if(photoInput.files.length===0){ alert('Photo required'); return; }

  const reader = new FileReader();
  reader.onload = (e)=>{
    const task = {
      id: uid(),
      title: document.getElementById('taskTitle').value || '(no title)',
      status: 'New',
      labels: { video: document.getElementById('taskVideo').checked },
      requireSets: Number(document.getElementById('taskSets').value)||1,
      willReceiveOn: document.getElementById('taskDate').value || '-',
      createdPhoto: { url: e.target.result, locked:true },
      uploads: [],
      doneBy: null,
      createdBy: currentRole,
      history:[`Created by ${currentRole}`]
    };
    tasks.push(task);
    renderTasks();
    document.getElementById('taskTitle').value='';
    photoInput.value='';
    document.getElementById('taskVideo').checked=false;
    document.getElementById('taskSets').value=1;
    document.getElementById('taskDate').value='';
  };
  reader.readAsDataURL(photoInput.files[0]);
}

function addUpload(task, file){
  if(!canUpload()){ alert('Cannot upload'); return; }
  const reader = new FileReader();
  reader.onload = (e)=>{
    const kind = file.type.startsWith('video/') ? 'video':'image';
    task.uploads.push({id:uid(), url:e.target.result, kind, by: currentRole});
    task.history.push(`Upload ${kind} by ${currentRole}`);
    renderTasks();
  };
  reader.readAsDataURL(file);
}

function changeStatus(task, newStatus){
  // video validation
  if(newStatus==='Submitted' && task.labels.video && !task.uploads.some(u=>u.kind==='video')){
    alert('Task requires at least 1 video before submitting');
    return;
  }
  // doneBy
  if(task.status==='Received' && newStatus==='Submitted') task.doneBy=currentRole;
  task.status = newStatus;
  task.history.push(`${task.status} by ${currentRole}`);
  renderTasks();
}

// --- Rendering ---
function renderTasks(){
  const container = document.getElementById('taskList');
  container.innerHTML='';
  tasks.forEach(task=>{
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <div><strong>${task.title}</strong> (${task.status})</div>
      <div>By: ${task.createdBy} ${task.doneBy? '| Done By: '+task.doneBy : ''}</div>
      <div>Sets: ${task.requireSets} ${task.labels.video? '| Video':''}</div>
      <div>Receive On: ${task.willReceiveOn}</div>
      <img src="${task.createdPhoto.url}">
      <div id="uploads_${task.id}"></div>
    `;

    const uploadsDiv = card.querySelector(`#uploads_${task.id}`);
    task.uploads.forEach(u=>{
      const upDiv = document.createElement('div');
      upDiv.innerHTML=`${u.kind} by ${u.by}<br>`;
      if(u.kind==='image') upDiv.innerHTML+=`<img src="${u.url}" style="width:120px"><br>`;
      else upDiv.innerHTML+=`<video src="${u.url}" controls style="width:150px"></video><br>`;
      uploadsDiv.appendChild(upDiv);
    });

    // Upload input
    if(canUpload() && ['Received','Redo'].includes(task.status)){
      const upInput = document.createElement('input');
      upInput.type='file';
      upInput.accept='image/*,video/*';
      upInput.onchange = (e)=>{ if(e.target.files[0]) addUpload(task,e.target.files[0]); e.target.value=''; };
      uploadsDiv.appendChild(upInput);
    }

    // Action buttons
    const actions = document.createElement('div');
    actions.style.marginTop='8px';

    if(canReceive(task)) actions.appendChild(btn('Receive',()=>changeStatus(task,'Received')));
    if(canSubmit(task)) actions.appendChild(btn('Submit',()=>changeStatus(task,'Submitted')));
    if(canRedo(task)) actions.appendChild(btn('Send Back (Redo)',()=>changeStatus(task,'Redo')));
    if(canComplete(task)) actions.appendChild(btn('Complete',()=>changeStatus(task,'Completed')));
    if(canArchive(task)) actions.appendChild(btn('Archive',()=>changeStatus(task,'Archived')));

    card.appendChild(actions);
    container.appendChild(card);
  });
}

function btn(label,fn){
  const b = document.createElement('button');
  b.innerText=label;
  b.className='btn btn-secondary';
  b.onclick=fn;
  return b;
}
</script>
</body>
</html>
